# @hatchifyjs/express

`@hatchifyjs/express` is an [NPM package](https://www.npmjs.com/package/@hatchifyjs/express) that takes a [Schema](../schema/README.md) and produces:

- [Sequelize](https://sequelize.org/) models,
- an expressive [JSON:API](../jsonapi/README.md) restful middleware, and
- utilities for building custom restful endpoints.

The following uses `hatchifyExpress` to create `POST`, `GET`, `PATCH`, and `DELETE` endpoints at `/api/todos`.

```ts
import { hatchifyExpress } from "@hatchifyjs/express"
import { datetime, string, PartialSchema } from "@hatchifyjs/core"
import Express from "express"

// Define the schema
const schemas = {
  Todo: {
    name: "Todo",
    attributes: {
      name: string(),
      dueDate: datetime(),
    },
  },
} satisfies Record<string, PartialSchema>

const app = Express()

// Pass schemas and other settings to configure hatchify
const hatchedExpress = hatchifyExpress(schemas, {
  prefix: "/api",
  database: { uri: "sqlite://localhost/:memory" },
})

;(async () => {
  // Update the database to match the schema
  await hatchedExpress.modelSync({ alter: true })

  // Create CRUD endpoints for all schemas
  app.use(hatchedExpress.middleware.allModels.all)

  app.listen(3000, () => {
    console.log("Started on http://localhost:3000")
  })
})()
```

- [Exports](#exports)
  - [hatchifyExpress](#hatchifyexpress) - Creates a `hatchedExpress` instance with middleware and sequelize ORMs
  - [HatchifyExpress](#hatchifyexpress-1) - A type for TypeScript usage
  - [JSONAPIDocument](#jsonapidocument) - A type for JSON:API document that can be used as a request/response body
  - [errorHandlerMiddleware](#errorhandlermiddleware) - An error handle that produces JSON:API formatted errors
- [`hatchedExpress`](#hatchedexpress) - An instance of `HatchifyExpress` with middleware and sequelize ORMs
  - [`hatchedExpress.everything[schemaName]`](#hatchedexpresseverythingschemanameallmodels) - Methods to parse a request, fetch data and serialize to a [JSON:API](../jsonapi/README.md) response.
  - [`hatchedExpress.middleware[schemaName|allModels]`](#hatchedexpressmiddlewareschemanameallmodels) - Middleware to call the matching [everything](#hatchedexpresseverythingschemanameallmodels) method.
  - [`hatchedExpress.modelSync`](#hatchedexpressmodelsync) - A utility function to make sure your schemas are always synced with the database.
  - [`hatchedExpress.orm`](#hatchedexpressorm) - A reference to the `Sequelize` instance when more control is needed.
  - [`hatchedExpress.parse[schemaName]`](#hatchedexpressparseschemaname) - Methods to parse a [JSON:API](../jsonapi/README.md) request and return options that can be passed to the [models](#hatchedexpressorm) to CRUD data.
  - [`hatchedExpress.printEndpoints`](#hatchedexpressprintendpoints) - Prints a list of endpoints generated by Hatchify.
  - [`hatchedExpress.schema[schemaName]`](#hatchedexpressschemaschemaname) - All the Hatchify final schemas.
  - [`hatchedExpress.serialize[schemaName]`](#hatchedexpressserializeschemaname) - methods to transform the result of [models](#hatchedexpressorm) back into a [JSON:API](../jsonapi/README.md) response.

## Exports

`@hatchifyjs/express` provides three named exports:

- hatchifyExpress - Creates a `hatchedExpress` instance with middleware and [Sequelize](https://sequelize.org/) ORM
- HatchifyExpress - A type for TypeScript fans
- errorHandlerMiddleware - A middleware to catch any Hatchify error and transform it to a proper [JSON:API](../jsonapi/README.md) response

```ts
import { hatchifyExpress, HatchifyExpress, errorHandlerMiddleware } from "@hatchifyjs/express"
```

### hatchifyExpress

`hatchifyExpress(schemas: Schemas, options: ExpressOptions)` is a `Function` that constructs a `hatchedExpress` instance with middleware and [Sequelize](https://sequelize.org/) ORM:

```ts
import { hatchifyExpress } from "@hatchifyjs/express";

const schemas = { ... }

const app = Express()

const hatchedExpress = hatchifyExpress(schemas, {
  prefix: "/api",
  database: { uri: "sqlite://localhost/:memory" },
})
```

**Parameters**

| Property                  | Type                                   | Default                    | Details                                                                                                                                           |
| ------------------------- | -------------------------------------- | -------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------- |
| schemas                   | Record<string, PartialSchema>          | {}                         | A collection of [Hatchify Schemas](../schema/README.md).                                                                                          |
| options.uri               | string                                 | sqlite://localhost/:memory | The database URI / connection string of the relational database. Ex. `postgres://user:password@host:port/database?ssl=true`                       |
| options.logging           | (sql: string, timing?: number) => void | undefined                  | A function that gets executed every time Sequelize would log something.                                                                           |
| options.additionalOptions | object                                 | undefined                  | An object of additional options, which are passed directly to the underlying connection library (example: [pg](https://www.npmjs.com/package/pg)) |

See [Using Postgres](../guides/using-postgres-db.md) for instructions on how to set up HatchifyJS with postgres.

**Returns**

Returns a [HatchifyExpress](#hatchifyexpress) instance which is documented below.

### HatchifyExpress

`HatchifyExpress` is the constructor function used to create a [hatchedExpress](#hatchedexpress) instance. This TypeScript type typically isn't used directly (it's exported to support implicit typing of the return from the `hatchifyExpress` constructor); however, it can be useful when defining a custom type that may reference `hatchedExpress`.

```ts
import type { HatchifyExpress } from "@hatchifyjs/express"
import { hatchifyExpress } from "@hatchifyjs/express"

type Globals = {
  hatchedExpress: HatchifyExpress
}

const globals : Globals = {
  hatchedExpress: hatchifyExpress(schemas, options);
}
```

### JSONAPIDocument

A type for JSON:API document that can be used as a request/response body.

[Read more on the type](https://github.com/DefinitelyTyped/DefinitelyTyped/blob/master/types/json-api-serializer/index.d.ts#L117)

### RecordObject

A "flattened" JavaScript object with the record's data and associated record's data as child RecordObjects. See [RecordObject](../react-jsonapi/README.md#recordobject) for more details.

```js
{
  id: string,
  name: string,
  complete: boolean,
  user: {
    id: string,
    email: string,
  },
}
```

### errorHandlerMiddleware

`errorHandlerMiddleware` is a middleware to catch any Hatchify error and transform it to a proper [JSON:API](../jsonapi/README.md) response. For example, the following shows a middleware that throws a fake error, preceded by `errorHandlerMiddleware`:

```ts
import { errorHandlerMiddleware } from "@hatchifyjs/express"

app.use(errorHandlerMiddleware)
app.use(() => {
  throw [new NotFoundError({ detail: "Fake error" })]
})
```

so any request will throw and handled to return an error similar to

```json
{
  "jsonapi": {
    "version": "1.0"
  },
  "errors": [
    {
      "status": 404,
      "code": "not-found",
      "detail": "Fake error",
      "title": "Resource not found."
    }
  ]
}
```

## hatchedExpress

`hatchedExpress` is an instance of [`HatchifyExpress`](#hatchifyexpress-1) that is returned by the [`hatchifyExpress`](#hatchifyexpress) function. It provides:

- [Sequelize](https://sequelize.org/) orm models,
- an expressive [JSON:API](../jsonapi/README.md) restful middleware, and
- utilities for building custom restful endpoints.

The following show some of the methods available given a `SalesPerson` schema:

<pre>
import { hatchifyExpress } from "@hatchifyjs/express";

const hatchedExpress = hatchifyExpress({SalesPerson: {...}, {prefix: "/api"})

hatchedExpress.<a href="../schema/README.md">schema</a>.SalesPerson  <b>// The full schemas</b>
hatchedExpress.modelSync()         <b>// Sync the database with the schema</b>
hatchedExpress.printEndpoints()    <b>// Prints a list of endpoints generated by Hatchify</b>

<b>// JSONAPI Middleware for CRUD operations</b>
app.use(hatchedExpress.middleware.<a href="./hatchedExpress.middleware.md#hatchedexpressmiddlewareallmodels">allModels</a>.<a href="./hatchedExpress.middleware.md#all">all</a>);
app.use(hatchedExpress.middleware.SalesPerson.<a href="./hatchedExpress.middleware.md#findandcountall">findAndCountAll</a>)
app.use(hatchedExpress.middleware.SalesPerson.<a href="./hatchedExpress.middleware.md#findone">findOne</a>)
app.use(hatchedExpress.middleware.SalesPerson.<a href="./hatchedExpress.middleware.md#create">create</a>)
app.use(hatchedExpress.middleware.SalesPerson.<a href="./hatchedExpress.middleware.md#update">update</a>)
app.use(hatchedExpress.middleware.SalesPerson.<a href="./hatchedExpress.middleware.md#destroy">destroy</a>)

<b>// Methods that do "everything" the middleware does</b>
await hatchedExpress.<a href="./hatchedExpress.everything.md">everything</a>.SalesPerson.<a href="./hatchedExpress.everything.md#findall">findAll</a>("filter[name]=Jane")
await hatchedExpress.everything.SalesPerson.<a href="./hatchedExpress.everything.md#findandcountall">findAndCountAll</a>("filter[name]=Baking")
await hatchedExpress.everything.SalesPerson.<a href="./hatchedExpress.everything.md#findOne">findOne</a>("filter[name]=Baking")
await hatchedExpress.everything.SalesPerson.<a href="./hatchedExpress.everything.md#create">create</a>({jsonapi: {...}, data: {...}})
await hatchedExpress.everything.SalesPerson.<a href="./hatchedExpress.everything.md#update">update</a>({jsonapi: {...}, data: {...}}, UUID)
await hatchedExpress.everything.SalesPerson.<a href="./hatchedExpress.everything.md#destroy">destroy</a>(UUID)

<b>// Parse JSONAPI requests into arguments for sequelize</b>
hatchedExpress.<a href="./hatchedExpress.parse.md">parse</a>.SalesPerson.<a href="./hatchedExpress.parse.md#findall">findAll</a>("filter[name]=Jane")
hatchedExpress.parse.SalesPerson.<a href="./hatchedExpress.parse.md#findandcountall">findAndCountAll</a>("filter[name]=Baking")
hatchedExpress.parse.SalesPerson.<a href="./hatchedExpress.parse.md#findOne">findOne</a>("filter[name]=Baking")
hatchedExpress.parse.SalesPerson.<a href="./hatchedExpress.parse.md#create">create</a>(JSONAPI_PAYLOAD)
hatchedExpress.parse.SalesPerson.<a href="./hatchedExpress.parse.md#update">update</a>(JSONAPI_PARTIAL_PAYLOAD, UUID)
hatchedExpress.parse.SalesPerson.<a href="./hatchedExpress.parse.md#destroy">destroy</a>(UUID)

<b>// Use the underlying sequelize methods</b>
await hatchedExpress.<a href="https://sequelize.org/docs/v6/core-concepts/model-basics/#model-definition">orm</a>.models.SalesPerson.<a href="https://sequelize.org/docs/v6/core-concepts/model-querying-basics/#specifying-attributes-for-select-queries">findAll</a>({where: {name: "Jane"}})
await hatchedExpress.orm.models.SalesPerson.<a href="https://sequelize.org/docs/v6/core-concepts/model-querying-basics/#simple-insert-queries">create</a>({name: "Justin"})
await hatchedExpress.orm.models.SalesPerson.<a href="https://sequelize.org/docs/v6/core-concepts/model-querying-basics/#simple-update-queries">update</a>({name: "Roye"},{where: {id: UUID}})
await hatchedExpress.orm.models.SalesPerson.<a href="https://sequelize.org/docs/v6/core-concepts/model-querying-basics/#simple-delete-queries">destroy</a>({where: {id: UUID}})

<b>// Serialize sequelize data back to JSONAPI responses</b>
hatchedExpress.<a href="./hatchedExpress.parse.md">serialize</a>.SalesPerson.<a href="./hatchedExpress.serialize.md#findall">findAll</a>([{ id: UUID, name: "Roye" }])
hatchedExpress.serialize.SalesPerson.<a href="./hatchedExpress.serialize.md#findandcountall">findAndCountAll</a>({rows: [{id: UUID, ...}], count: 1})
hatchedExpress.serialize.SalesPerson.<a href="./hatchedExpress.serialize.md#findOne">findOne</a>({ id: UUID, name: "Roye" })
hatchedExpress.serialize.SalesPerson.<a href="./hatchedExpress.serialize.md#create">create</a>({ id: UUID, name: "Roye" })
hatchedExpress.serialize.SalesPerson.<a href="./hatchedExpress.serialize.md#update">update</a>({ id: UUID, name: "Roye" }, 1)
hatchedExpress.serialize.SalesPerson.<a href="./hatchedExpress.serialize.md#destroy">destroy</a>()
</pre>

### hatchedExpress.everything[schemaName|allModels]

[`hatchedExpress.everything[schemaName|allModels]`](./hatchedExpress.everything.md) functions very similar to the `middleware` export but is expected to be used more directly, usually when defining user-created middleware.

The `everything` functions takes the same properties as `parse` but goes further than just building the query options. This function will do a complete operation of parsing the request, performing the ORM query operation and then serializing the resulting data to JSON:API format.

For example `hatchedExpress.everything.Todo.findAll` takes the URL query params and directly returns JSON:API ready response data.

```ts
router.get("/todos", async (req: Request, res: Response) => {
  const serializedTodos = await hatchedExpress.everything.Todo.findAll(req.originalUrl.split("?")[1] || "")
  return res.json(serializedTodos)
})
```

### hatchedExpress.middleware[schemaName|allModels]

[`hatchedExpress.middleware[schemaName|allModels]`](./hatchedExpress.middleware.md)

All of the `middleware` functions export a Express Middleware that can be passed directly to a Express `app.use` or a Express `router[verb]` function, mounted to a specific URL/path. The normal [schemaName] export expects to be used with:

- findAll
- findOne
- findAndCountAll
- create
- update
- destroy

### hatchedExpress.modelSync

`hatchedExpress.modelSync({ alter: true } | { force: true } | undefined)`

A utility function to make sure your schemas are always synced with the database.

If your database is created externally to Hatchify, you do not need to worry about it. Otherwise, Hatchify makes it simple by offering 3 syncing options:

```ts
hatchedExpress.modelSync()
```

This creates the table if it does not exist (and does nothing if it already exists)

- Postgres: Namespaces (Postgres Schemas) are handled manually

```ts
hatchedExpress.modelSync({ alter: true })
```

This checks what is the current state of the table in the database (which columns it has, what are their data types, etc), and then performs the necessary changes in the table to make it match the model.

- Postgres: Namespaces (Postgres Schemas) are created

```ts
hatchedExpress.modelSync({ force: true })
```

This creates the table, dropping it first if it already existed

- Postgres: Namespaces (Postgres Schemas) and their tables are dropped and recreated

### hatchedExpress.orm

A reference to the `Sequelize` instance when more control is needed.

```ts
hatchedExpress.orm.models.Todo.findAll()
```

### hatchedExpress.parse[schemaName|allModels]

[hatchedExpress.parse[schemaName|allModels]](./hatchedExpress.parse.md) has methods to parse a [JSON:API](../jsonapi/README.md) request and return options that can be passed to the [models](#hatchedexpressorm) to CRUD data.

### hatchedExpress.printEndpoints

`hatchedExpress.printEndpoints()`

Prints a list of endpoints generated by Hatchify. This can be useful for debugging 404 errors.

Example output:

```bash
Hatchify endpoints:
GET    /api/todos
POST   /api/todos
GET    /api/todos/:id
PATCH  /api/todos/:id
DELETE /api/todos/:id
GET    /api/users
POST   /api/users
GET    /api/users/:id
PATCH  /api/users/:id
DELETE /api/users/:id
```

### hatchedExpress.middleware.allModels.all

This exports a single middleware function that based on the method and the URL will call the right `everything` function. It is useful as a default handler to handle all Hatchify `GET`/`POST`/`PATCH`/`DELETE` endpoints.

```ts
app.use(hatchedExpress.middleware.allModels.all)
```

### hatchedExpress.schema[schemaName]

`hatchedExpress.schema[schemaName]`

The `schema` export provides access to all the Hatchify final schemas. This can be useful for debugging the schemas you provided.

```ts
console.log(hatchedExpress.schema)
// {
//   Todo: {
//     name: "Todo",
//     namespace: "Admin",
//     pluralName: "Todos",
//     attributes: { ... },
//     relationships: {
//       user: { ... }
//     }
//   },
//   ...
// }
```

### hatchedExpress.serialize[schemaName]

[hatchedExpress.serialize[schemaName]](./hatchedExpress.serialize.md) has methods to transform the result of [models](#hatchedexpressorm) back into a [JSON:API](../jsonapi/README.md) response.
