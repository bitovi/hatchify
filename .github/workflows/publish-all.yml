name: publish-all
on:
  push:
    branches: [main]
jobs:
  publish-all:
    if: ${{!contains(github.event.head_commit.message, 'skip-publish')}}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v42
        with:
          safe_output: false
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install dependencies
        run: npm ci
      - name: Get changed packages
        id: changed-packages
        env:
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
          TOUCHED_FILES: ${{ steps.changed-files.outputs.all_changed_and_modified_files }}
        run: npm run --silent get-changed-packages >> $GITHUB_OUTPUT
      - name: Publish crypto
        if: ${{ steps.changed-packages.outputs.crypto == 'publish' }}
        uses: ./.github/actions/job-publish
        with:
          directory: crypto
          npm-token: ${{ secrets.NPM_TOKEN }}
          github-token: ${{ github.token }}
          segment: ${{ steps.changed-packages.outputs.segment }}
      - name: Publish core
        if: ${{ steps.changed-packages.outputs.core == 'publish' }}
        uses: ./.github/actions/job-publish
        with:
          directory: core
          npm-token: ${{ secrets.NPM_TOKEN }}
          github-token: ${{ github.token }}
          segment: ${{ steps.changed-packages.outputs.segment }}
      - name: Publish node
        if: ${{ steps.changed-packages.outputs.node == 'publish' }}
        uses: ./.github/actions/job-publish
        with:
          directory: node
          npm-token: ${{ secrets.NPM_TOKEN }}
          github-token: ${{ github.token }}
          segment: ${{ steps.changed-packages.outputs.segment }}
      - name: Publish express
        if: ${{ steps.changed-packages.outputs.express == 'publish' }}
        uses: ./.github/actions/job-publish
        with:
          directory: express
          npm-token: ${{ secrets.NPM_TOKEN }}
          github-token: ${{ github.token }}
          segment: ${{ steps.changed-packages.outputs.segment }}
      - name: Publish koa
        if: ${{ steps.changed-packages.outputs.koa == 'publish' }}
        uses: ./.github/actions/job-publish
        with:
          directory: koa
          npm-token: ${{ secrets.NPM_TOKEN }}
          github-token: ${{ github.token }}
          segment: ${{ steps.changed-packages.outputs.segment }}
      - name: Publish rest-client
        if: ${{ steps.changed-packages.outputs.rest-client == 'publish' }}
        uses: ./.github/actions/job-publish
        with:
          directory: rest-client
          npm-token: ${{ secrets.NPM_TOKEN }}
          github-token: ${{ github.token }}
          segment: ${{ steps.changed-packages.outputs.segment }}
      - name: Publish rest-client-jsonapi
        if: ${{ steps.changed-packages.outputs.rest-client-jsonapi == 'publish' }}
        uses: ./.github/actions/job-publish
        with:
          directory: rest-client-jsonapi
          npm-token: ${{ secrets.NPM_TOKEN }}
          github-token: ${{ github.token }}
          segment: ${{ steps.changed-packages.outputs.segment }}
      - name: Publish react-rest
        if: ${{ steps.changed-packages.outputs.react-rest == 'publish' }}
        uses: ./.github/actions/job-publish
        with:
          directory: react-rest
          npm-token: ${{ secrets.NPM_TOKEN }}
          github-token: ${{ github.token }}
          segment: ${{ steps.changed-packages.outputs.segment }}
      - name: Publish react-ui
        if: ${{ steps.changed-packages.outputs.react-ui == 'publish' }}
        uses: ./.github/actions/job-publish
        with:
          directory: react-ui
          npm-token: ${{ secrets.NPM_TOKEN }}
          github-token: ${{ github.token }}
          segment: ${{ steps.changed-packages.outputs.segment }}
      - name: Publish react-jsonapi
        if: ${{ steps.changed-packages.outputs.react-jsonapi == 'publish' }}
        uses: ./.github/actions/job-publish
        with:
          directory: react-jsonapi
          npm-token: ${{ secrets.NPM_TOKEN }}
          github-token: ${{ github.token }}
          segment: ${{ steps.changed-packages.outputs.segment }}
      - name: Publish design-mui
        if: ${{ steps.changed-packages.outputs.design-mui == 'publish' }}
        uses: ./.github/actions/job-publish
        with:
          directory: design-mui
          npm-token: ${{ secrets.NPM_TOKEN }}
          github-token: ${{ github.token }}
          segment: ${{ steps.changed-packages.outputs.segment }}
      - name: Publish react
        if: ${{ steps.changed-packages.outputs.react == 'publish' }}
        uses: ./.github/actions/job-publish
        with:
          directory: react
          npm-token: ${{ secrets.NPM_TOKEN }}
          github-token: ${{ github.token }}
          segment: ${{ steps.changed-packages.outputs.segment }}
      - name: Publish create
        if: ${{ steps.changed-packages.outputs.create == 'publish' }}
        uses: ./.github/actions/job-publish
        with:
          directory: create
          npm-token: ${{ secrets.NPM_TOKEN }}
          github-token: ${{ github.token }}
          segment: ${{ steps.changed-packages.outputs.segment }}
